version: "3"
services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: dashboard-api
    ports:
      - "8000:8000"
    environment:
      - PYTHONPATH=/app
      - DATABASE_PATH=/data/plugin_registry.db
      - DATASET_DIR=/datasets
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=minioadmin
      - MINIO_BUCKET_NAME=workflow-tools
      - USE_SSL=false
      - FHIR_ENDPOINT=hapi-fhir:8080/fhir
      - HOST=130.216.217.176
    env_file:
      - ./backend/.env
    volumes:
      - digitaltwins_portal_datasets:/data/download_datasets
      - ./backend/datasets:/app/datasets
      - ./backend/configs.ini:/app/configs.ini
      - /var/run/docker.sock:/var/run/docker.sock
    restart: unless-stopped
    networks:
      - digitaltwins-portal-network
    depends_on:
      - minio

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_APP_API_URL: ${VITE_APP_API_URL}
    container_name: digitaltwins-ai-platform
    ports:
      - "80:80"
    restart: unless-stopped
    networks:
      - digitaltwins-portal-network
    depends_on:
      - backend
  
  minio:
    image: quay.io/minio/minio:latest
    ports:
      - '8004:9000'
      - '8005:9001'
    networks:
      - digitaltwins-portal-network
    volumes:
      - 'minio_data:/data'
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
      - MINIO_SERVER_ACCESS_KEY=minioadmin
      - MINIO_SERVER_SECRET_KEY=minioadmin
    command: server /data --console-address ":9001" --address ":9000"
  
  hapi-fhir:
    image: hapiproject/hapi:latest
    container_name: hapi-fhir
    restart: on-failure
    ports:
      - "8080:8080"
    networks:
      - digitaltwins-portal-network
    volumes:
      - ./hapi/application.yaml:/app/config/application.yaml
    environment:
      - SPRING_CONFIG_LOCATION=/app/config/application.yaml
    depends_on:
      - hapi-fhir-postgres

  hapi-fhir-postgres:
    image: postgres:13-alpine
    container_name: hapi-fhir-postgres
    restart: always
    networks:
      - digitaltwins-portal-network
    environment:
      POSTGRES_DB: "hapi"
      POSTGRES_USER: "admin"
      POSTGRES_PASSWORD: "admin"
    volumes:
      - hapi-fhir-postgres:/var/lib/postgresql/data

networks:
  digitaltwins-portal-network:
    driver: bridge

volumes:
  digitaltwins_portal_datasets:
  hapi-fhir-postgres:
  minio_data:
    driver: local

